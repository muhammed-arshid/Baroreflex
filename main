from pandas import DataFrame 
import pandas as pd
import numpy as np
from numpy import diff
from scipy.stats import linregress
from scipy.signal import butter, lfilter, freqz
import matplotlib.pyplot as plt

df = pd.read_csv('/Users/twitter/Desktop/Python Projects/Sample Data/Sample_ECG5.txt', delimiter = "\t", index_col=0)
frame = DataFrame(df)

df.columns=['ecg', 'bp', 'time2']
ECG = frame['ecg']

#Low pass filter for ECG signal
def butter_lowpass(cutoff, fs, order=5):
    nyq = 0.5 * fs
    normal_cutoff = cutoff / nyq
    b, a = butter(order, normal_cutoff, btype='low', analog=False)
    return b, a

def butter_lowpass_filter(data, cutoff, fs, order=5):
    b, a = butter_lowpass(cutoff, fs, order=order)
    y = lfilter(b, a, data)
    return y

Filtered_ECG = butter_lowpass_filter(ECG, 3.667, 1000.0, order=5)

# Filter requirements.
order = 6
fs = 30.0       # sample rate, Hz
cutoff = 3.667  # desired cutoff frequency of the filter, Hz

# Get the filter coefficients so we can check its frequency response.
b, a = butter_lowpass(cutoff, fs, order)

frame2 = DataFrame(df, columns=['ecg', 'bp', 'time2', 'filtered_ecg'])
frame2['filtered_ecg'] = Filtered_ECG

#QRS threshold 
threshold = (np.max(frame2.filtered_ecg) - (np.max(frame2.filtered_ecg)-np.min(frame2.filtered_ecg))*.2)

#QRS detection
ind = 0
ind2 = 0
hbindex = [frame2.index[0]]
heartbeat = []
RRindex = []
hbs = [0]
timestamp = []
for x in Filtered_ECG:
    ind += 1
    if x > threshold and Filtered_ECG[ind-1] > Filtered_ECG[(ind-1)-1] and Filtered_ECG[ind-1] > Filtered_ECG[(ind-1)+1]:  
        ind2 += 1
        hbs.append(ind2)
        heartbeat.append(ind2)
        hbindex.append(frame2.index[ind]) #timestamp for all detectected QRS in ECG
    else:
        heartbeat.append(ind2)

frame2['heart_beat'] = heartbeat
frame2.index.names = ['time']

#Heart Rate
RR = np.diff(hbindex)
HR = 60/RR
RR[0] = RR[1]
HR[0] = HR[1]

#beat to beat BP values for each QRS
sbp = []
mbp = []
dbp = []
for x in hbs:
    sbp.append(np.max(frame2[frame2.heart_beat == x].bp))
    mbp.append(np.mean(frame2[frame2.heart_beat == x].bp))
    dbp.append(np.min(frame2[frame2.heart_beat == x].bp))
